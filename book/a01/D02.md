# 互补滤波器

2007年，Shane Colton发表了一篇经典白皮书《The Balance Filter》，里面提出了一种对加速度传感器与陀螺仪进行数据融合的有效方法——互补滤波器。互补滤波器包括低通滤波器（滤除或衰减短期加速度传感器波动），以及高通滤波器（消除漂移对陀螺仪的影响）。

在开始讲解前，我们有必要先了解两个概念：

> + 低通滤波器（英语：Low-pass filter）容许低频信号通过，但减弱（或减少）频率高于截止频率的信号的通过。对于不同滤波器而言，每个频率的信号的减弱程度不同。
> + 高通滤波器（英语：High-pass filter）则相反。

这两个概念接下来将会反复提起，所以务必先牢记。

加速度传感器可以测量由地球引力作用或者物体运动所产生的加速度。理论上，通过加速度传感器就可以获得小车的倾角，再对此信号进行微分便可以获得倾角速度。但在实际小车运行过程中，由于小车本身的摆动所产生的加速度会产生很大的干扰信号，它叠加在上述测量信号上使得输出信号无法准确反映小车的倾角。下图是实际测量安装在小车上MPU-6050的Y轴信号。小车倾角在两个角度位置过渡，看到除了角度变化信号之外，还存在由于运动引起的加速度噪声等，这个噪声波动随着小车运动速度增加会变得很大。因此，对于加速度传感器，需要低通滤波器进行校正。

陀螺仪可以用来测量物体的旋转角速度。理论上，在小车上安装陀螺仪，可以测量小车倾斜角速度，对角速度信号进行积分便可以得到小车的倾角。实际中，由于从陀螺仪角速度获得角度信息，需要经过积分运算。如果角速度信号存在微小的偏差和漂移（实际上存在偏差和漂移），经过积分运算之后，变化形成积累误差。这个误差会随着时间延长逐步增加，最终导致信号失真，无法形成正确的角度信号。因此陀螺仪数据需要高通滤波器校正。

在惯性测量单元（IMU）中，加速度传感器与陀螺仪两者常常组合在一起使用，通过合适的滤波算法，对二者“取长补短”，以期获得精确数据。相对卡尔曼滤波器的复杂运算，互补滤波器由低通和高通滤波器组成，在代码上更容易实现。
 
互补滤波器用公式表述出来是这样的：

> ` 陀螺仪积分角度 += 陀螺仪角速度 * dt；`<br>
> `融合角度 =  加权系数 * 陀螺仪积分角度 + (1 – 加权系数) * 加速度角度；`

在互补滤波公式中，像陀螺仪角速度、加速度角度这些数据可以直接从陀螺仪、加速度传感器中读取得到。可是，加权系数是怎么得来的呢？ 

在《The Balance Filter》中提到关于加权系数的求解公式。在这里，先设滤波器的加权系数为a，时间常数为τ，运行周期为dt，那么公式为：

> `a=τ/(τ+dt)`

运行周期`dt`通常都是能提前计算出来的。比如在小霸王Lite的程序里，互补滤波器在`1s（=1000ms）`中运行200次，那么`dt=1000ms/200hz=5ms`。

时间常数τ的取值是由我们根据系统的实际滤波需求调整的。时间常数τ是“信任”陀螺仪和“信任”加速度传感器之间的边界值。若时间常数τ取值越大，则更加“信任”陀螺仪积分，但跟随加速度传感器的速度会变慢。若时间常数τ取值越小，则更加“信任”加速度传感器，但同时引入加速度传感器中更多的噪声。通常，互补滤波器是为了得到更“纯”的融合角度，必须要“信任”陀螺仪积分多些，以削弱加速度传感器中噪声的影响。

为了方便理解，这里举个例子进行说明：

若互补滤波器放在`10ms（=0.01s）`周期中循环运行，时间常数`τ=0.49`，那么此时加权系数为：

`a=τ/(τ+dt)=0.49/(0.49+0.01)=0.98`

使用c语言将互补滤波器封装起来是这样：
```c
// a=tau / (tau + dt)  
// acc = 加速度传感器数据 
// gyro = 陀螺仪数据 
// dt = 运行周期 	  
float tau=0.49;  
float a=0.0;  	  
float ComplementaryFliter(float acc, float gyro,int dt) {  
a=tau/(tau+dt);  
angle= a* (angle + gyro * dt) + (1-a) * (acc);  
return angle;  
} 
``` 

函数的入口参数是加速度传感器数据、陀螺仪数据和运行周期。经过计算后，函数返回融合角度。

为了更进一步了解加权系数的作用，这里留意两个极端情况：

+ 若`a=1`时，那么滤波器变成`angle=angle+gyro×dt`，失去了加速度传感器的修正效果，变成了一个纯粹的陀螺仪积分器，此时互补滤波器“完全信任”陀螺仪。
+ 若`a=0`时，那么互补滤波器变成`angle=acc`，此时陀螺仪完全失去了作用，融合角度直接等于加速度传感器数值，此时互补滤波器“完全信任”加速度传感器。

由此可见，加权系数a值的大小决定了互补滤波器是“信任”陀螺仪还是加速度传感器，直接决定了互补滤波器的效果。

当然，互补滤波器也存在缺陷，其中有两点需要特别注意：

+ 初始化时不能及时跟随实际角度。这种情况，跟融合角度变量没有正确初始化和互补滤波器的时间常数取值有关。时间常数约大，陀螺仪积分比重越大，跟随加速度传感器的速度约慢，这意味着初始化时融合角度可能是不精准的。
+ 陀螺仪的零漂问题。理论上，陀螺仪在静止的时候，读出来的数值应该为0，但实际上往往不为0，那么这个值被称为零漂值。陀螺仪每次上电的零漂值是随机的。互补滤波器并不能有效地过滤掉陀螺仪的零漂。
