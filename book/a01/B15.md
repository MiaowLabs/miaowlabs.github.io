# MPU6050使用教程与姿态融合算法

> 本节讲解如何使用 MPU-6050，并且对其数据进行数据融合，得到能应用的姿态值。

MPU-6050 是一款运动处理传感器，其内部封装了三轴陀螺仪和三轴加速度计，还有 DMP 功能，其中的 DMP 是一个可通过 IIC 接口扩展的数字运动处理器。 

DMP（an onboard Digital Motion Processor），是一个已经整合在 MPU-6050 内部的数字运动处理器。MPU-6050 通过 DMP 解算出陀螺仪和加速度数据融合后的四元数，存储在其内部的FIFO中，使用者通过 IIC 接口就能读取到姿态数据，减轻了处理器的负荷，适合简单的开发应用。

![](/img/mpu-6000-family-diagram.png)

但是，DMP 这种硬核解算也存在缺点，比如刷新频率固定无法更改，刷新频率只有100Hz。因此，在例如四轴飞行器、两轮自平衡小车这样的要求高刷新频率的应用场合，通常都会采用软件解算，以提升刷新频率和提高数据精度。

我总结了下，使用 MPU-6050 有以下几个步骤：

>   1. 学习协议 I2C。这是基础，因为 I2C 是 MPU-6050 传送数据到单片机的一种协议。
>   2. 了解芯片寄存器。了解如何设置 MPU-6050 的关键寄存器，让 MPU-6050 先工作起来。我推荐大伙阅读英文原版 Datasheet ，实在不行再找网络译本，通过翻阅 Datasheet，并且结合例程就能轻易获得数据。
>   3. 数据融合。得到原始数据后还不能直接应用，需要进行数据融合，得到我们需要的三轴姿态值。

### 硬件接口

下图是小霸王Lite项目使用的 MPU-6050 模块：

![](/img/2018-12-09_180904.png)

下表是该模块的引脚功能汇总：

|引脚|名称|说明|
|:--:|:--:|:--:|
|1|VCC|3.3V-5V电源输入|
|2|GND|地线|
|3|SCL|MPU-6050 作为从机时 IIC 通信时钟线|
|4|SDA|MPU-6050 作为从机时 IIC 通信数据线|
|5|XDA|MPU-6050 作为主机时 IIC 通信时钟线，用于外接传感器|
|6|XCL|MPU-6050 作为主机时 IIC 通信时钟线，用于外接传感器|
|6|AD0|地址管脚:ID：0x68(AD0=0)、 0x69(AD0=1)|
|7|INT|中断引脚|

该模块总共有 8 个引脚，但是在制作两轮自平衡小车项目，我们通常不需要连接其他的 IIC 从设备，因此，只需要用到 VCC、GND、SCL、SDA 四个引脚。

### （一）I2C


I2C是由信号串行数据（SDA）和串行时钟（SCL）组成的双线接口。一般来说，这些线路是开漏和双向的。在广义的I2C接口实现中，连接的设备可以是主设备或从设备。主设备将从设备地址放在总线上，并且具有匹配地址的从设备确认主设备。

系统处理器（MPU-60X0）作为从设备与主系统处理器进行通信。SDA和SCL线通常需要上拉电阻（4.7k电阻）到 VDD。最大总线速度是 400 kHz。

MPU-60X0的从机地址为 b110100X，长度为7位。7位地址的LSB位由引脚AD0的逻辑电平决定。这允许两个MPU-60X0 连接到同一个I2C总线。在此配置中使用时，其中一个设备的地址应为b1101000（AD0引脚为逻辑低电平），另一个的地址应为b1101001（AD0引脚为逻辑高电平）。

PS：讲到这里就搞明白了，为什么AD0接地了！！

### （二）MPU6050初始化

MPU-6050 通过 IIC 协议与单片机进行通信。我使用STM32时通常采用软件模拟IIC的方式。

寄存器的查阅

　　MPU6050的所有寄存器都可以在官方文档“MPU-6000 and MPU-6050 Register Map and DescripTIons”中找到，平时使用中最为重要的有以下几种：电源管理寄存器1和2、陀螺仪配置寄存器、陀螺仪采样率分频寄存器、加速度传感器配置寄存器、配置寄存器。

　　以电源管理寄存器为例：

寄存器地址：0x6B（Hex）或107（十进制）。

　　表格后面的几位Bit7~Bit0代表八位二进制，给该寄存器赋值就是改变这几位的值。各个位代表的意义可看表下方的说明：如DEVICE_RESET ：When set to 1， this bit resets all internal registers to their default values.The bit automaTIcally clears to 0 once the reset is done.表明DEVICE_RESET被置1时芯片就会将所有内部寄存器复位。

对MPU6050的初始化驱动就是通过IIC的协议，对MPU6050的寄存器进行初始化配置，我选择配置的有：

> * 设置电源管理寄存器1（0X6B），复位MPU6050 （下面举例）
> * 设置陀螺仪配置寄存器（0X1B），将量程设置为 2000dps
> * 设置加速度计配置寄存器（0X1C），将量程设置为 2g
> * 设置采样频率分频器（0X19），将采样率设置为50Hz
> * 设置中断使能寄存器（0X38），关闭中断
> * 设置电源管理寄存器2（0X6C），使加速度陀螺仪都工作

　　//以下函数通过IIC协议，修改MPU6050的电源管理寄存器，实现复位

　　//其中的（IIC_……）函数为IIC通信函数，可从名字中了解大致功能，具体应用可参见IIC通信协议的内容

　　char MPU_Reset（）

　　{

　　IIC_Start（）;

　　IIC_Send_Byte（（0x68《《1）|0）; //发送器件地址+写命令

　　if（IIC_Wait_Ack（））

　　{

　　IIC_Stop（）;

　　return 1;

　　}

　　IIC_Send_Byte（0x6B）; //写寄存器地址，选择电源管理寄存器1

　　IIC_Wait_Ack（）;

　　IIC_Send_Byte（0x80）; //发送数据（1000 0000）第七位为1，复位

　　if（IIC_Wait_Ack（））

　　{

　　IIC_Stop（）;

　　return 1;

　　}

　　IIC_Stop（）;

　　return 0;

　　}

　　按照相同的方法对其余的寄存器进行配置之后，MPU6050就可以正常工作了。接下来的任务就是不断读取它的数据，计算出芯片的姿态了。。。

### （三）读取MPU-6050输出数据






