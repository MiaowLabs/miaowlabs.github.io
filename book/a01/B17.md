# 角度环PID参数整定及调试

两轮自平衡小车的调试，包括平衡小车的直立环、速度环、转向环，一般的调试步骤是先调试直立环，再调试速度环，最后调试转向环。另外，需要说明的是，因为“小霸王Lite”设计方案使用的电机的性能很好，对PID参数不敏感，也就是说每个参数的取值范围都比较广，这将对我们接下来的调试有很大的帮助。

### 直立控制调试 

两轮自平衡小车直立环使用PD（比例微分）控制器，其实一般的控制系统单纯的P控制或者PI控制就可以了，但是那些对干扰要做出迅速响应的控制过程需要D（微分）控制。

下面是直立PD控制的代码：
```c
1.	/*************************************************************** 
2.	** 作　  者: 喵呜实验室MiaowLabs 
3.	** 官    网：http://www.miaowlabs.com 
4.	** 淘    宝：https://miaowlabs.taobao.com/ 
5.	** 日　  期: 2018年08月27日 
6.	** 函数名称: AngleControl 
7.	** 功能描述: 角度环控制函数            
8.	** 输　  入:    
9.	** 输　  出:    
10.	** 备    注:  
11.	********************喵呜实验室MiaowLabs版权所有************************** 
12.	***************************************************************/  
13.	void AngleControl(void)    
14.	{  
15.	    g_fAngleControlOut =  (g_fCarAngle-CAR_ANGLE_SET) * g_tCarAnglePID.P + \  
16.	    (g_fGyroAngleSpeed-CAR_ANGLE_SPEED_SET) * g_tCarAnglePID.D;  
17.	}  
```

先简单说明下角度环控制函数AgnleControl（）里面用到的变量：

> * g_fCarAngle：小车角度； 
> * g_fGyroAngleSpeed：小车角速度，其实就是陀螺仪数值；
> * CAR_ANGLE_SET：小车期望角度值，宏定义，在control.h里面可以看到设定为0，因为我们期望小车保持直立，随时保持为角度为0的状态。
> * CAR_ANGLE_SPEED_SET：小车期角速度值，宏定义，在control.h里面可以看到设定为0，因为我们期望小车保持直立，随时保持为角速度为0的状态。

PD控制比较简洁明了，就一句话，通过PD控制器计算直立控制PWM。

调试过程包括确定平衡小车的机械中值、确定 kp 值的极性（也就是正负号）和大小、kd 值的极性和大小等步骤。

在调试直立环的时候，我们要在滴答定时中断服务函数里面屏蔽速度环，如下图所示：

```c
1.	void SysTick_Handler(void)  
2.	{    
3.	    SoftTimerCountDown();            //软定时器  
4.	  
5.	    g_u8MainEventCount++;  
6.	  
7.	    g_u8SpeedControlPeriod++;       
8.	    //SpeedControlOutput();          //速度环控制输出函数，每1ms执行一次  
9.	    if(g_u8MainEventCount>=5)  
10.	    {  
11.	        g_u8MainEventCount=0;  
12.	        GetMotorPulse();             //捕获电机脉冲（速度）函数，每5ms执行一次  
13.	    }  
14.	    else if(g_u8MainEventCount==1)  
15.	    {  
16.	        MPU6050_Pose();              //读取MPU6050数据函数，每5ms执行一次  
17.	        AngleCalculate();            //角度环计算函数，每5ms执行一次  
18.	    }  
19.	    else if(g_u8MainEventCount==2)  
20.	    {  
21.	        AngleControl();              //角度环控制函数，每5ms执行一次  
22.	  
23.	    }  
24.	    else if(g_u8MainEventCount==3)  
25.	    {  
26.	        g_u8SpeedControlCount++;  
27.	        if(g_u8SpeedControlCount >= 5)//25ms  
28.	        {         
29.	            //SpeedControl();          //车模速度控制函数，每25ms调用一次  
30.	            g_u8SpeedControlCount=0;  
31.	        g_u8SpeedControlPeriod=0;  
32.	        }  
33.	    }  
34.	    else if(g_u8MainEventCount==4)  
35.	    {  
36.	        //MotorManage();            //电机使能/失能控制函数，每5ms执行一次  
37.	        MotorOutput();          //电机输出函数，每5ms执行一次  
38.	    }  
39.	}  
```

### 确定平衡小车的机械中值 

先注释掉两轮自平衡小车的PWM输出函数，关闭小车的电机转动。把小车放在地面上，绕电机轴旋转平衡小车，记录能让小车接近平衡的角度，一般都在0°附近的。我们调试的小车正好是0度，所以就是小车机械中值，即角度期望值CAR_ANGLE_SET设置为0。

### 确定 kp 值的极性（令kd=0） 

首先我们估计kp的取值范围。我们的PWM设置的是1000代表占空比 100%，假如我们设定kp值为250，那么平衡小车在±4°的时候就会满转。根据我们的感性认识，这显然太大了，那我们就可以估计 kp值在0~250之间，首先大概我们给一个值 kp=-20,我们可以观察到，小车往哪边倒，电机会往那边加速让小车到下，就是一个我们不愿看到的正反馈的效果。说明kp值的极性反了，接下来我们设定 kp=20,这个时候可以看到平衡小车有直立的趋势，虽然响应太慢，但是，我们可以确定kp值极性是正的。具体的数据接下来再仔细调试。

### 确定 kp 值的大小（令 kd=0，请结合本小节开头的直立控制函数理解） 

确定参数的原则是： 
> * kp一直增加，直到出现大幅度的低频摆动。
> * 设定 kp=20,这个时候我们可以看到，小车虽然有平衡的趋势，但是显然响应太慢了。
> * 设定 kp=40,这个时候我们可以看到，小车虽然有平衡的趋势，而且响应有所加快，但是响应还是不足以让小车保持平衡。
> * 设定 kp=60，这个时候我们可以看到，小车的响应明显加快，而且来回推动小车的时候，会有大幅度的低频摆动。说明这个时候 kp 值已经足够大了，需要增加微分控制削弱 p控制，抑制低频摆动。

### 确定 kd 值的极性（令 kp=0） 

我们得到的 MPU6050 输出的陀螺仪的原始数据，通过观察数据，我们发现最大值不会超过4位数（正常应用在平衡小车上的时候），在经过单位换算（/20）后，数值不超过50， 再根据1000代表占空比 100%，所以我们估算 kd 值应该在 0~20之间，我们先设定 kd=-1，当我们拿起小车旋转的时候，车轮会反向转动，并没有能够实现跟随效果。这说明了kd的极性反了。接下来，我们设定 kd=1。这个时候我们可以看到，当我们旋转小车的时候，车轮会同向以相同的速度跟随转动，这说明我们实现了角速度闭环，至此，我们可以确定 kd的极性是正的。具体的数据接下来再仔细调试。

### 确定 kd 值的大小（令 kp=60，请结合本小节开头的直立控制函数理解） 

确定参数的原则是： kd一直增加，直到出现高频抖动。设定 kd=2,这个时候我们可以看到，低频大幅度频抖动已经基本消除。设定 kd=4,这个时候我们可以看到，整体性能已经非常棒。设定 kd=6,这个时候我们可以看到，小车开始出现高频剧烈抖动。

这里要说明的是，如果电机驱动的峰值电流比电机堵转电流小，出现小车高频抖动时，长时间高频抖动会导致驱动被烧坏的。“小霸王Lite”的驱动模块和电机之间的电流留有余量，则不会出现烧坏驱动的问题。

至此，我们可以确定得到 kp=100，kd=6 是 P、D 参数的最大值。然后我们进行最关键的一步，对每个系数乘以0.9。取整得到 kp=90，kd=5.4，这就是最终我们需要的参数，这样做的原因是，我们之前得到的参数是kp、kd 临界值，理想值是根据我们的工程经验，对每个数据乘以0.9得到。这个时候我们可以看到，小车运行非常平稳，但是依然无法保持长时间的直立，直立很短一段时间后会往一个方向加速倒下。这个等我们下面加上速度环才能得到更好的性能。只有直立环是很难让小车达到很好的直立效果的。 至此，直立调试部分就告一段落了。

