# STM32基础外设——GPIO

GPIO 是学习嵌入式、学习单片机、学习 STM32 的第一个知识点。

GPIO 全称为 General-Purpose Inputs/Outputs，中文翻译为「通用输入/输出端口」，是 STM32 用于输出信号，输入信号的通道。

根据数据手册中列出的每个 I/O 端口的特定硬件特征，  GPIO 端口的每个引脚可以由软件分别配置成多种模式。

输入模式：

* 输入浮空 GPIO_Mode_IN_FLOATING
* 输入上拉 GPIO_Mode_IPU
* 输入下拉 GPIO_Mode_IPD
* 模拟输入 GPIO_Mode_AIN

输出模式：

* 开漏输出 GPIO_Mode_AF_OD
* 推挽式输出 GPIO_Mode_Out_PP 
* 开漏复用功能 GPIO_Mode_AF_OD
* 推挽式复用功能 GPIO_Mode_AF_PP 

接下来，我将分别介绍每个模式的原理以及用途。首先，要祭出「I/O端口引脚的基本结构」图，我们要对着结构图进行剖析。

![](/img/2019-04-26_223150.png)

我们从上图能看到两条虚线分别框住的两个部分，即输入驱动器和输出驱动器。输入驱动器的主要元件是 TTL 施密特(肖特基)触发器。这个触发器的主要作用是：设定电压阈值，超过/低于该电压，才可通过。输出驱动器的主要元件是 P-MOS 管和一个 N-MOS 管。

这里插入补充一下 MOS 管的相关知识，因为这对于我们后面理解结构图会有很大的帮助。

MOS 管是由加在输入端栅极的电压(GU)来控制输出端漏极的电流（DI）的元器件。它类似于三极管，有三个极，分别为栅极/门极（G）,源极（Source）和漏极（Drain）。按沟道半导体材料的不同，结型和绝缘栅型各分「N 沟道」和「P 沟道」两种。若按导电方式来划分，场效应管又可分为「耗尽型」与「加强型」。结型场效应管均为耗尽型，绝缘栅型场效应管既有耗尽型的，也有加强型的。如下图：

![](/img/2019-04-26_225037.png)

我们可以从上图看到 N-MOS 管的箭头指向绝缘板。MOS 管有一个重要的参数就是开启电压。对于 N-MOS 管来说，这里我们要想让源极 S 和漏极 D 之间开始通电，则栅极和源级之间的电压必须大于开启电压。同理，对于 P-MOS 管，栅极和源级电压必须小于开启电压。比如说，这里我们开启电压是 5v，源级电压是 12v，栅极电压要12 + 5 = 17v 才能导通。

导通特性：

* N-MOS 的特性，Vgs 大于一定的值就会导通，适合用于漏极 D 接电源，源极 S 接地时的情况（低端驱动），只要栅极电压达到 4v 或 10v 就可以了。需要注意的是，Vgs 指的是栅极 G 与源极 S 的电压。
* P-MOS 的特性，Vgs 小于一定的值就会导通，适合用于源极接 VCC 时的情况（高端驱动）。但是，虽然 P-MOS 可以很方便地用作高端驱动，但由于导通电阻大，价格贵，替换种类少等原因，在高端驱动(大功率)中，通常还是使用 N-MOS。

### 模式详解

作为新手，初次接触到一堆新名词，例如「浮空输入 GPIO_Mode_IN_FLOATING」、「上拉输入 GPIO_Mode_IPU」，了解新名词不等于掌握知识点，还需要深入探究。

###### 1、输入浮空 GPIO_Mode_IN_FLOATING

![](/img/2019-04-27_121111.png)

浮空输入的路线为红色标注部分，外部的电平信号通过右边编号 1 的 I/O 引脚进入 STM32，经过编号 2 的施密特触发器的整形，再送入编号 3 的输入数据寄存器储存，在输入数据寄存器的另一端(编号 4)，CPU 可以随时读出 I/O 引脚的电平状态。我们可以看到红色标注的整条输入路线既没有内部上拉电路，也没有内部下拉电路，所以称之为「浮空输入」。

###### 2、输入上拉 GPIO_Mode_IPU

![](/img/2019-04-27_235022.png)

与前面的浮空输入模式相比，仅仅是在数据通道上部，接入了一个内部上拉电阻，并接到设备电压（VDD）。根据 STM32 的数据手册，该内部上拉电阻阻值介于30K~50K欧姆。同样，CPU 可以随时在输入数据寄存器的另一端，读出 I/O 端口的电平状态。

在上拉输入中，接入上拉电阻的目的是为了保证在无信号输入时 IO 口的电平为高电平。同时，当信号输入为低电平时，IO口的电平应该也为低电平。如果没有上拉电阻，在没有外界输入的情况下输入端是悬空的，它的电平是未知的、无法保证的，上拉电阻就是为了保证无信号输入时输入端的电平为高电平。同理，还有下拉电阻它是为了保证无信号输入时输入端的电平为低电平。

###### 3、输入下拉 GPIO_Mode_IPD

![](/img/2019-04-27_235733.png)

数据通道的下部，接入了一个下拉电阻，并接到电路共地端（VSS）。根据 STM32 的数据手册，该下拉电阻阻值也是介于 30K~50K 欧姆。

###### 4、模拟输入 GPIO_Mode_AIN

![](/img/2019-04-28_000313.png)

模拟通道输入的配置则更加简单，信号从右边编号 1 的端口进入，从左边编号 2 的一端直接进入 ADC 模块。 
这里看到所有的上拉、下拉电阻和施密特触发器，均处于断开状态，因此输入数据寄存器将不能反映端口上的电平状态，也就是说，模拟输入配置下，CPU 不能在输入数据寄存器上读到有效的数据。这也是为什么我们在选择 ADC 采集时，不能通过直接读取 GPIO 输入数据寄存器来获得模拟电压值，而是必须读取 ADC 数据寄存器的值。

###### 5、开漏输出 GPIO_Mode_AF_OD

![](/img/2019-05-04_193837.png)

这是开漏输出模式的配置，当CPU在左边的编号 1 端通过位设置/清除寄存器或输出数据寄存器写入数据后，该数据位将通过编号 2 的输出控制电路控制 3，将信号传送到编号 4 的 I/O 端口。

如果 CPU 写入的是逻辑 1 ，则编号 3 的 N-MOS 管将处于关闭状态，此时 I/O 端口的电平将由外部的上拉电阻决定，如果 CPU 写入的是逻辑 0 ，则编号 3 的 N-MOS 管将处于开启状态，此时 I/O 端口的电平被编号 3 的 N-MOS 管拉到了 VSS 的零电位。 

同理，根据蓝色线路，施密特触发器处于开启状态，这意味着 CPU 可以在“输入数据寄存器”的另一端，随时监控 I/O 端口的状态。通过这个特性，还实现了虚拟的 I/O 端口双向通信：只要 CPU 输出逻辑 1 ，由于编号 3 的 N-MOS 管处于关闭状态，I/O 端口的电平将完全由外部电路决定，因此，CPU 可以在输入数据寄存器读到外部电路的信号，而不是它自己输出的逻辑 1。 

开漏形式的电路有以下几个特点： 
1. 利用外部电路的驱动能力，减少 IC 内部的驱动。当 IC 内部 MOSFET 导通时，驱动电流是从外部的 VCC 流经电阻上拉后 ，从 MOSFET 到 GND。IC 内部仅需很小的栅极驱动电流。 
2. 一般来说，开漏是用来连接不同电平的器件，匹配电平用的，因为开漏引脚不连接外部的上拉电阻时，只能输出低电平，如果需要同时具备输出高电平的功能，则需要接上拉电阻，很好的一个优点是通过改变上拉电源的电压，便可以改变传输电平。比如加上上拉电阻就可以提供 TTL/CMOS 电平输出等。（上拉电阻的阻值决定了逻辑电平转换的沿的速度 。阻值越大，速度越低功耗越小，所以负载电阻的选择要兼顾功耗和速度。） 
3. 开漏提供了灵活的输出方式，但是也有其弱点，就是带来上升沿的延时。因为上升沿是通过外接上拉无源电阻对负载充电，所以当电阻选择小时延时就小，但功耗大；反之延时大功耗小。所以如果对延时有要求，则建议用下降沿输出。 
4. 可以将多个开漏输出的 Pin，连接到一条线上。通过一只上拉电阻，在不增加任何器件的情况下，形成“与逻辑”关系。这也是 I2C，SMBus 等总线判断总线占用状态的原理。

###### 6、推挽式输出 GPIO_Mode_Out_PP

![](/img/2019-05-04_193837.png)

当输出逻辑 1 时，编号 3 处的 P-MOS 管导通，而下方的 N-MOS 管截止，达到输出高电平的目的。 

当输出逻辑 0 时，编号 3 处的 P-MOS 管截止，而下方的 N-MOS 管导通，达到输出低电平的目的。

在这个模式下，CPU 仍然可以从输入数据寄存器读到外部电路的信号。 

推挽结构一般是指两个三极管分别受两互补信号的控制，总是在一个三极管导通的时候另一个截止。高低电平由 IC 的电源低定。 

推挽电路是两个参数相同的三极管或 MOSFET，以推挽方式存在于电路中，各负责正负半周的波形放大任务，电路工作时，两只对称的功率开关管每次只有一个导通，所以导通损耗小、效率高。输出既可以向负载灌电流，也可以从负载抽取电流。推拉式输出级既提高电路的负载能力，又提高开关速度。

###### 7、开漏复用功能 GPIO_Mode_AF_OD

![](/img/2019-05-04_195701.png)

开漏复用输出模式与开漏输出模式的配置基本相同。不同的是编号2的输出控制电路的输入与复用功能的输出端相连，此时输出数据寄存器被从输出通道断开了。

同样，CPU 可以从输入数据寄存器读到外部电路的信号。

###### 8、推挽式复用功能 GPIO_Mode_AF_PP 

![](/img/2019-05-04_195701.png)

最后是推挽复用输出模式，同样的道理，编号 2 的输出控制电路的输入，与复用功能的输出端相连，此时输出数据寄存器被从输出通道断开了。 

其它部分与开漏复用功能一致，包括对输入数据寄存器的读取。

应用场合：片内外设功能（I2C 的 SCL/SDA）

###### 小结

本节介绍了 STM32 基础外设——GPIO 的 8 种配置模式，并分别讲解了每个模式的具体工作流程。