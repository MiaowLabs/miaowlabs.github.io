# 平衡小车的倾角测量

> 本节讲解如何通过MPU-6050的原始数据得到两轮自平衡小车中使用的倾角。

在上一节中介绍了小车直立控制算法，通过测量小车的角度和角速度控制小车车轮的加速度来消除小车的倾倒趋势。因此，小车角度以及角速度的测量成为控制小车直立的关键。测量小车角度和角速度可以通过安装在小车上的加速度传感器和陀螺仪实现。

### （一）加速度传感器

角度的测量可以使用加速度传感器。加速度传感器可以测量由地球引力或者物体运动所产生的加速度。InvenSense公司推出的MPU-6050就是集成了三轴加速度传感器，可以通过IIC接口同时输出三个方向上的加速度信号。



理想情况下，我们只需测量其中一个方向上的加速度值，就可以计算出小车的倾角。比如使用Y轴，或者X轴。小车静止时，只存在重力加速度，没有运动加速度，此时X轴和Y轴都输出0。当小车有一定的倾角之后，g会在X轴或Y轴上有重力加速度分量，而且该轴倾斜的角度和重力分量的大小相关。因为我们使用的是三轴的加速度计，所以可以使用atan2(y,x)函数更科学地计算倾角。

![](/img/1200px-Atan2definition.svg.png)

$$Angle\_Y=atan2(Accel\_Y,Accel\_Z)*180/PI$$

$$Angle\_X=atan2(Accel\_X,Accel\_Z)*180/PI$$

atan2(y,x)是表示X-Y平面上所对应的（x,y）坐标的角度，返回的是原地至点（x,y）的方位角，即与坐标系的x轴的夹角，如图3所示。它的值域范围是（-PI，PI），也就是输出值要通过*180/PI转化成角度。

$$Accel\_X$$、$$Accel\_Y$$、$$Accel\_Z$$分别表示重力加速度在该轴的分量。

似乎我们已经通过加速度计完成了角度的测量，然后通过差分求得角速度即可。我们先看一下加速度计在实际运动时的输出，如图4所示。

之前的分析是基于加速度计只测量重力加速度的前提下的，但是实际上，由于运动加速度的累加，会影响角度测量的精度。下面简单分析运动所产生的干扰信号。

$$\beta$$为小车的倾角，在没有运动加速度叠加的理想情况下，Y轴加速度传感器测量值为

$$Accel\_Y=sin\beta * g$$

实际运动中小车的Y轴加速度传感器测量值

$$Accel_Y=sin\beta * g + cos\beta * a$$

其中a为小车的运动加速度，由小车的角加速度$$h\alpha$$和行走的线加速度$$a_1$$组成

$$a=a_1+h\alpha$$

h为MPU-6050到电机轴的距离，理论上把MPU-6050安装得离电机轴越近越好，这样可以减小运动角速度对角度测量的干扰，但是工程实践中，这样传感器容易受到电机的影响导致稳定性下降。而且就算是避免了运动的角加速度，线加速度也是无法避免的，所以无法彻底消除运动加速度对角度测量的影响。

### (二)陀螺仪

陀螺仪是利用高速回转体的动量矩敏感壳体相对惯性空间绕正交于自转轴的一个或二个轴的角运动检测装置。利用其它原理制成的角运动检测装置起同样功能的也程陀螺仪。一般我们使用陀螺仪对角速度进行测量。而MPU-6050里面也集成了三轴陀螺仪。所以我们下面继续使用MPU-6050测量运动角速度。

因为陀螺仪输出的是角速度，所以不受小车运动的影响。根据经验，我们可以对角速度进行积分得到角度，这样我们又多了一种传感器可以测量角度了。比如我们在一个5ms的定时中断服务函数里面执行以下语句

$$Angle\_X = Angle\_X - Gyro\_X*0.005$$

$$Gyro\_X$$为陀螺仪的输出，注意此时的单位必须是°/s。

MPU-6050输出的陀螺仪原始数据是-32767-32768,转换成单位为°/s的数据可以根据以下语句

$$Gyro\_X = Gyro\_X / k$$

其中k和我们初始化时的量程有关，可以在MPU-6050的手册中查到，当初始化为±2000°/s时，k=16.4。

由于从陀螺仪测量的角速度获得角度信息，需要听过积分运算。如果角速度信号存在微小的偏差和漂移，比如陀螺仪在静止时，输出不为0。经过积分运算之后，变化形成累积误差，这个误差会随着时间的延长逐步增加，无法输出正确的角度信号。

下面我们做一个实验，让一个小车在桌面上直立，然后轻轻拍打着桌面。我们通过上位机观察3条曲线。

可以看到，陀螺仪积分得到的角度因为自身的零点漂移，误差随时间变化逐步增加，误差越来越大。加速度传感器测量的角度信号在受到外界干扰的情况下，会有很大的毛刺，而通过算法融合得到的角度值则非常稳定。










